name: Build and Publish ESPHome firmware

on:
  pull_request:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "**.yaml"

# Prevent multiple deployments at the same time
concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

jobs:
  build-ha:
    name: Build Everything Presence Lite HA
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: esphome/build-action@v6
        id: esphome-build
        with:
          yaml-file: everything-presence-lite-ha.yaml
          version: latest
      - run: |
          mkdir -p output/everything-presence-lite-ha
          mv "${{ steps.esphome-build.outputs.name }}"/* output/everything-presence-lite-ha/
      - name: Create manifest
        run: |
          jq '{
            "name": "Everything Presence Lite HA",
            "version": "${{ steps.esphome-build.outputs.project-version }}",
            "home_assistant_domain": "esphome",
            "new_install_skip_erase": false,
            "builds": [.]
          }' output/everything-presence-lite-ha/manifest.json > output/everything-presence-lite-ha-manifest.json

          # Fix paths in manifest
          jq '
            .builds[].ota.path |= "everything-presence-lite-ha/\(.)" |
            .builds[].parts[].path |= "everything-presence-lite-ha/\(.)"
          ' output/everything-presence-lite-ha-manifest.json > output/temp.json
          mv output/temp.json output/everything-presence-lite-ha-manifest.json
      - uses: actions/upload-artifact@v4
        with:
          name: firmware-ha
          path: output/

  build-ha-no-ble:
    name: Build Everything Presence Lite HA No BLE
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: esphome/build-action@v6
        id: esphome-build
        with:
          yaml-file: everything-presence-lite-ha-no-ble.yaml
          version: latest
      - run: |
          mkdir -p output/everything-presence-lite-ha-no-ble
          mv "${{ steps.esphome-build.outputs.name }}"/* output/everything-presence-lite-ha-no-ble/
      - name: Create manifest
        run: |
          jq '{
            "name": "Everything Presence Lite HA No BLE",
            "version": "${{ steps.esphome-build.outputs.project-version }}",
            "home_assistant_domain": "esphome",
            "new_install_skip_erase": false,
            "builds": [.]
          }' output/everything-presence-lite-ha-no-ble/manifest.json > output/everything-presence-lite-ha-no-ble-manifest.json

          # Fix paths in manifest
          jq '
            .builds[].ota.path |= "everything-presence-lite-ha-no-ble/\(.)" |
            .builds[].parts[].path |= "everything-presence-lite-ha-no-ble/\(.)"
          ' output/everything-presence-lite-ha-no-ble-manifest.json > output/temp.json
          mv output/temp.json output/everything-presence-lite-ha-no-ble-manifest.json
      - uses: actions/upload-artifact@v4
        with:
          name: firmware-ha-no-ble
          path: output/

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-ha, build-ha-no-ble]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Download HA firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-ha
          path: output/

      - name: Download HA No BLE firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-ha-no-ble
          path: output/

      - name: Copy static files
        run: cp -R static/* output/

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: output
          clean: true
          force: true
