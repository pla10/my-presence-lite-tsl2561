name: Build and Publish ESPHome firmware

on:
  pull_request:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "**.yaml"

# Prevent multiple deployments at the same time
concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-ha:
    name: Build Everything Presence Lite HA
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: esphome/build-action@v6
        id: esphome-build
        with:
          yaml-file: everything-presence-lite-ha.yaml
          version: latest
      - run: |
          mkdir -p output/everything-presence-lite-ha
          mv "${{ steps.esphome-build.outputs.name }}"/* output/everything-presence-lite-ha/
      - name: Create manifest
        run: |
          jq '{
            "name": "Everything Presence Lite HA",
            "version": "${{ steps.esphome-build.outputs.project-version }}",
            "home_assistant_domain": "esphome",
            "new_install_skip_erase": false,
            "builds": [.]
          }' output/everything-presence-lite-ha/manifest.json > output/everything-presence-lite-ha-manifest.json

          # Fix paths in manifest
          jq '
            .builds[].ota.path |= "everything-presence-lite-ha/\(.)" |
            .builds[].parts[].path |= "everything-presence-lite-ha/\(.)"
          ' output/everything-presence-lite-ha-manifest.json > output/temp.json
          mv output/temp.json output/everything-presence-lite-ha-manifest.json
      - uses: actions/upload-artifact@v4
        with:
          name: firmware-ha
          path: output/

  build-ha-no-ble:
    name: Build Everything Presence Lite HA No BLE
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: esphome/build-action@v6
        id: esphome-build
        with:
          yaml-file: everything-presence-lite-ha-no-ble.yaml
          version: latest
      - run: |
          mkdir -p output/everything-presence-lite-ha-no-ble
          mv "${{ steps.esphome-build.outputs.name }}"/* output/everything-presence-lite-ha-no-ble/
      - name: Create manifest
        run: |
          jq '{
            "name": "Everything Presence Lite HA No BLE",
            "version": "${{ steps.esphome-build.outputs.project-version }}",
            "home_assistant_domain": "esphome",
            "new_install_skip_erase": false,
            "builds": [.]
          }' output/everything-presence-lite-ha-no-ble/manifest.json > output/everything-presence-lite-ha-no-ble-manifest.json

          # Fix paths in manifest
          jq '
            .builds[].ota.path |= "everything-presence-lite-ha-no-ble/\(.)" |
            .builds[].parts[].path |= "everything-presence-lite-ha-no-ble/\(.)"
          ' output/everything-presence-lite-ha-no-ble-manifest.json > output/temp.json
          mv output/temp.json output/everything-presence-lite-ha-no-ble-manifest.json
      - uses: actions/upload-artifact@v4
        with:
          name: firmware-ha-no-ble
          path: output/

  build-ha-no-ble-h2:
    name: Build Everything Presence Lite HA No BLE H2
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: esphome/build-action@v6
        id: esphome-build
        with:
          yaml-file: everything-presence-lite-ha-no-ble-h2.yaml
          version: latest
      - run: |
          mkdir -p output/everything-presence-lite-ha-no-ble-h2
          mv "${{ steps.esphome-build.outputs.name }}"/* output/everything-presence-lite-ha-no-ble-h2/
      - name: Create manifest
        run: |
          jq '{
            "name": "Everything Presence Lite HA No BLE H2 (OpenThread)",
            "version": "${{ steps.esphome-build.outputs.project-version }}",
            "home_assistant_domain": "esphome",
            "new_install_skip_erase": false,
            "builds": [.]
          }' output/everything-presence-lite-ha-no-ble-h2/manifest.json > output/everything-presence-lite-ha-no-ble-h2-manifest.json

          # Fix paths in manifest
          jq '
            .builds[].ota.path |= "everything-presence-lite-ha-no-ble-h2/\(.)" |
            .builds[].parts[].path |= "everything-presence-lite-ha-no-ble-h2/\(.)"
          ' output/everything-presence-lite-ha-no-ble-h2-manifest.json > output/temp.json
          mv output/temp.json output/everything-presence-lite-ha-no-ble-h2-manifest.json
      - uses: actions/upload-artifact@v4
        with:
          name: firmware-ha-no-ble-h2
          path: output/

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-ha, build-ha-no-ble, build-ha-no-ble-h2]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Download HA firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-ha
          path: _site/

      - name: Download HA No BLE firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-ha-no-ble
          path: _site/

      - name: Download HA No BLE H2 firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-ha-no-ble-h2
          path: _site/

      - name: Copy static files
        run: cp -R static/* _site/

      - name: Create index.html
        run: |
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Everything Presence Lite - Firmware</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              a { color: #0066cc; }
              .firmware { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px; }
            </style>
          </head>
          <body>
            <h1>Everything Presence Lite - Custom Firmware</h1>
            <p>TSL2561 light sensor version with GPIO2 LED</p>
            <div class="firmware">
              <h3>Everything Presence Lite HA (with BLE)</h3>
              <a href="everything-presence-lite-ha-manifest.json">Manifest JSON</a>
            </div>
            <div class="firmware">
              <h3>Everything Presence Lite HA No BLE</h3>
              <a href="everything-presence-lite-ha-no-ble-manifest.json">Manifest JSON</a>
            </div>
            <div class="firmware">
              <h3>Everything Presence Lite HA No BLE H2 (OpenThread)</h3>
              <p>ESP32-H2 with Thread/Matter networking - requires Thread Border Router</p>
              <a href="everything-presence-lite-ha-no-ble-h2-manifest.json">Manifest JSON</a>
            </div>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
